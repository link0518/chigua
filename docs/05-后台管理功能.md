# 05｜后台管理功能

后台前端入口为 `/tiancai`（见 `App.tsx` 的路由映射），由 `components/AdminGate.tsx` 负责登录门禁，登录后进入 `components/AdminDashboard.tsx`。

## 1. 启用条件

后端满足以下条件时才会启用后台：

- `SESSION_SECRET` 不为空
- `ADMIN_USERNAME` 不为空
- `ADMIN_PASSWORD` 不为空

若缺失任一项，`AdminGate` 会提示“后台未启用”，需要补齐 `.env.local` 后重启服务。

## 2. 后台主要模块（页面/功能）

后台 UI 以 `AdminDashboard` 为主体，包含多个视图（内部切换）。

### 2.1 概览（overview）

典型内容：

- 统计卡片（今日举报、封禁数、访问/发帖趋势等）
- 图表（按周数据）

数据来源：

- `GET /api/admin/stats`

### 2.2 举报处理（reports / processed）

能力点：

- 查看待处理举报列表
- 对举报执行动作：忽略 / 删除 / 封禁（可选带权限与时长）
- 批量处理（若 UI 支持）
- 查看举报详情（不展开接口示例）

数据来源：

- `GET /api/reports`
- `POST /api/reports/:id/action`（需要 CSRF）
- `POST /api/admin/reports/batch`（需要 CSRF）

### 2.3 帖子管理（posts）

能力点（概念上）：

- 列表：按时间/热度/举报数等排序，按状态筛选（正常/已删除）
- 单条操作：删除/恢复、封禁作者等
- 批量操作：对选中帖子执行相同动作
- 进入某帖评论列表（用于评论治理）

数据来源：

- `GET /api/admin/posts`
- `POST /api/admin/posts/:id/action`（需要 CSRF）
- `POST /api/admin/posts/batch`（需要 CSRF）
- `GET /api/admin/posts/:id/comments`

### 2.4 后台发帖/编辑（compose / edit）

能力点：

- 后台发帖（可用于公告、运营贴等）
- 编辑既有帖子（会记录编辑原因，并写入编辑记录/审计）

数据来源：

- `POST /api/admin/posts`（需要 CSRF）
- `POST /api/admin/posts/:id/edit`（需要 CSRF）

### 2.5 评论治理（posts/:id/comments + comment action）

能力点：

- 在“某帖评论列表”中对单条评论执行动作

数据来源：

- `POST /api/admin/comments/:id/action`（需要 CSRF）

**删除语义（重要）：**

当前后台删除评论是“软删除当前一条”，不级联删除其所有回复：

- 服务端仅执行 `UPDATE comments SET deleted = 1 ... WHERE id = ?`
- 并将 `posts.comments_count` 减 1

若未来需要“删除楼层时连带删除回复树”，必须在业务逻辑中实现级联软删策略，并明确 `comments_count` 的一致性规则。

### 2.6 封禁管理（bans）

能力点：

- 查询封禁列表
- 对 IP / 指纹执行封禁与解封
- 选择封禁权限（post/comment/like/view/site）与时长（1h/1d/7d/永久/自定义）

数据来源：

- `GET /api/admin/bans`
- `POST /api/admin/bans/action`（需要 CSRF）

### 2.7 反馈管理（feedback）

能力点：

- 查看用户反馈
- 标记已读/删除/对相关用户执行封禁

数据来源：

- `GET /api/admin/feedback`
- `POST /api/admin/feedback/:id/action`（需要 CSRF）

### 2.8 审计日志（audit）

能力点：

- 查看后台操作日志（谁在什么时候对什么执行了什么动作）

数据来源：

- `GET /api/admin/audit-logs`

### 2.9 公告（announcement）

能力点：

- 编辑/预览公告（前台会显示公告入口）
- 清空公告

数据来源：

- `GET /api/admin/announcement`
- `POST /api/admin/announcement`（需要 CSRF）
- `POST /api/admin/announcement/clear`（需要 CSRF）

### 2.10 设置（settings）

能力点：

- 开关 Turnstile 等站点级配置

数据来源：

- `GET /api/admin/settings`
- `POST /api/admin/settings`（需要 CSRF）

### 2.11 敏感词（vocabulary）

能力点：

- 查询敏感词列表（分页）
- 新增、启用/禁用、删除
- 从 `Vocabulary/*.txt` 导入 / 导出

数据来源：

- `GET /api/admin/vocabulary`
- `POST /api/admin/vocabulary`（需要 CSRF）
- `POST /api/admin/vocabulary/:id/toggle`（需要 CSRF）
- `POST /api/admin/vocabulary/:id/delete`（需要 CSRF）
- `POST /api/admin/vocabulary/import`（需要 CSRF）
- `GET /api/admin/vocabulary/export`

## 3. 与前端状态的关系

前端 `store/AppContext.tsx` 会维护：

- `adminSession`：是否登录、csrf token、是否禁用后台
- `reports` / `stats` 等后台数据缓存

后台页面在登录后通常会触发加载：

- `loadReports()`
- `loadStats()`

