# 06｜部署与运维

本项目提供了两类“运维友好脚本”：

- 一键部署：`deploy.sh`（适合新机器初始化）
- 更新脚本：`update.sh`（保留本地改动）与 `update-force.sh`（丢弃本地改动）

## 1. 生产构建

```bash
npm run build
```

产物输出到 `dist/`。生产环境通常需要：

- 前端静态站点（由 Nginx/Caddy/pm2 serve 等提供）
- 后端 API 常驻进程（pm2 / systemd 等）
- 反向代理将 `/api/*` 以及部分 SEO 相关路径转发给后端

## 2. 脚本：deploy.sh（一键部署）

目标：在 Debian VPS 上完成依赖安装、拉取仓库、构建、用 pm2 启动服务，并用 Caddy 配置反代。

关键动作（以脚本逻辑为准）：

- 检查并安装：`git`、Node.js 18、`pm2`、`caddy`
- 拉取代码：
  - 若当前目录已有 `.git`：强制 `git reset --hard origin/main`
  - 若当前目录非空且无 `.git`：会中止以避免覆盖文件
  - 若空目录：`git clone` 到当前目录
- 创建 `.env.local`（若不存在）
- `npm install` + `npm run build`
- pm2 启动：
  - `chigua-api`：`pm2 start npm --name chigua-api -- run server`
  - `chigua-web`：`pm2 serve dist 4396 --spa --name chigua-web`
- Caddy 反代（默认端口写死为 4395/4396）

可选环境变量：

- `DOMAIN`：Caddy 站点地址（默认 `:80`）

## 3. 脚本：update.sh（保留本地改动）

目标：在已部署目录做更新。

关键动作：

- 检查存在 `.git`
- 如本地有改动，会 `git stash push -u`
- `git pull`
- 尝试 `git stash pop`（若冲突需手工解决）
- `npm install` + `npm run build`
- pm2 restart（不存在则 start）

## 4. 脚本：update-force.sh（丢弃本地改动）

目标：强制对齐远端分支，清理所有本地修改与未跟踪文件。

关键动作：

- `git fetch --all`
- 自动识别远端默认分支（优先 origin/HEAD，其次 origin/main，最后 origin/master）
- `git reset --hard <remote_ref>`
- `git clean -fd`
- `npm install` + `npm run build`
- pm2 restart（不存在则 start）

## 5. 反向代理要点

开发模式由 Vite proxy 处理；生产模式需要反代：

- 前端请求 `/api/*` 必须转发给后端
- 同时根据项目 SEO/分享逻辑，`/post/*`、`/robots.txt`、`/sitemap.xml` 常见也需要转发给后端

脚本 `deploy.sh` 已给出 Caddy 片段配置，可作为参考。

## 6. 数据备份与恢复

- 备份：复制 `server/data/app.db`
- 恢复：替换 `server/data/app.db` 后重启后端进程

## 7. 性能预算

项目提供 `npm run perf:budget`（见 `scripts/perf-budget.mjs`）用于 Lighthouse 预算检查。适合在发布前或 CI 中执行。

