# 02｜架构总览

本项目是“前后端同仓”的单体应用：

- 前端：Vite + React + TypeScript（入口 `index.tsx`，页面/组件位于 `components/`）
- 后端：Express（入口 `server/index.js`）
- 数据：SQLite（由 `server/db.js` 初始化并持久化到 `server/data/app.db`）

## 1. 运行时端口与流量路径

- 后端 API：默认 `4395`（环境变量 `PORT`）
- 前端 Dev：默认 `4396`（环境变量 `VITE_PORT`，见 `vite.config.ts`）

开发模式下：

- 浏览器访问 `http://localhost:4396`
- 前端请求统一走 `/api/*`
- Vite proxy 将 `/api/*` 转发到 `http://localhost:${PORT}`（见 `vite.config.ts`）

生产模式下常见做法：

- `npm run build` 生成 `dist/`
- 用反向代理（如 Caddy/Nginx）同时：
  - 将 `/api/*`、`/post/*`、`/robots.txt`、`/sitemap.xml` 转发给后端
  - 其余静态资源与 SPA 路由由前端静态站点承接（或由后端 `express.static(DIST_DIR)` 提供）

## 2. 前端结构

### 2.1 入口与路由

- 入口：`index.tsx` 渲染 `App`，并用 `AppProvider` 提供全局状态
- 顶层：`App.tsx`
  - 使用 `window.location.pathname` 做“轻路由”
  - 主要路径映射：
    - `/` 与 `/post/:id`：首页/帖子详情（同一视图）
    - `/search`：搜索
    - `/favorites`：收藏
    - `/tiancai`：后台入口（管理员）

### 2.2 API 调用

- `api.ts` 统一封装 `fetch('/api' + path)`
  - 自动附带 `credentials: 'include'`（依赖 cookie session）
  - 针对部分接口会附带 `X-Client-Fingerprint`
  - 对后台/举报相关请求会附带 `X-CSRF-Token`（登录后由后端下发并写入内存变量）

### 2.3 状态管理

- `store/AppContext.tsx` 负责：
  - 缓存首页/列表/举报/统计等数据
  - 提供业务动作（发帖、评论、点赞、收藏、举报、后台处理等）
  - Toast 统一提示

## 3. 后端结构

- `server/index.js`：
  - 读取 `.env.local` / `.env`
  - Express 中间件：压缩、JSON body
  - Session：`express-session` + `better-sqlite3-session-store`
  - Turnstile 校验：通过 Cloudflare `siteverify` 进行服务端验证
  - 业务路由：公共 API、后台 API、SEO/静态资源等

## 4. 数据结构概览

详见 `docs/03-数据模型(SQLite).md`，本节只描述大类：

- 内容：`posts`、`comments`
- 互动：`post_reactions_*`、`post_views`、`post_favorites`、`comment_likes`
- 风控：`reports`、`*_report_sessions`、`*_report_fingerprints`、`banned_*`
- 后台：`users`（管理员）、`admin_audit_logs`（审计）、`post_edits`（编辑记录）
- 站点：`announcements`、`app_settings`、`vocabulary_words`、统计相关表

